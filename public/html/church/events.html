<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events | Martin Luther</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="../../css/header.css">
  <link rel="stylesheet" href="../../css/footer.css">
  <link rel="stylesheet" href="../../css/church/events.css">
</head>

<body>
  <!-- ‚úÖ Dynamic Header -->
  <div id="header"></div>

  <!-- HERO SECTION -->
  <section class="events-hero">
    <div class="events-overlay">
      <h1>Upcoming Events</h1>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main class="events-grid" id="events-grid">
    <!-- üü¶ Events load dynamically here -->
  </main>

  <!-- ‚úÖ Dynamic Footer -->
  <div id="footer"></div>

  <!-- ‚úÖ Core JS -->
  <script src="../../js/header.js"></script>
  <script src="../../js/footer.js"></script>

  <!-- ‚úÖ Dynamic Event Loader -->
  <script>
    // Fetch and dynamically inject events
    fetch("/content/events.json")
      .then(res => res.json())
      .then(data => {
        const grid = document.getElementById("events-grid");
        const events = data.events || [];
        const isAdmin = localStorage.getItem("isAdmin") === "true";

        // üß± Wrap each event pair in .event-row to keep order consistent
        grid.innerHTML = events.map((ev, index) => {
          const savedNotes = localStorage.getItem(`eventNotes_${index}`) || "*Insert text here*";

          const textBlock = `
            <div class="grid-item grey">
              <div class="text-box">
                <div class="event-header">
                  <h2 id="event-title-${index}">${ev.title}</h2>
                  ${isAdmin ? `<button class="edit-btn" data-type="title" data-index="${index}">‚úèÔ∏è Edit</button>` : ""}
                  <p class="event-date" id="event-date-${index}">${ev.date}</p>
                  ${isAdmin ? `<button class="edit-btn" data-type="date" data-index="${index}">üìÖ Edit</button>` : ""}
                </div>
                <p>${ev.description || ""}</p>
                <div class="event-admin-section">
                  <div id="admin-text-${index}" class="admin-display-text">${savedNotes}</div>
                  <button class="save-notes-btn" data-index="${index}" style="display:${isAdmin ? 'inline-block' : 'none'};">
                    Save Notes
                  </button>
                </div>
              </div>
            </div>
          `;

          const imageBlock = `
            <div class="grid-item white" style="position:relative;">
              <img src="/${ev.image}" alt="${ev.title}" class="event-img">
              ${isAdmin ? `<div class="image-edit-overlay" data-index="${index}">üñºÔ∏è Edit Image</div>` : ""}
            </div>
          `;

          // üü¢ FIXED LAYOUT LOGIC
          // Odd-indexed events (1, 3, 5...) now render IMAGE first, then TEXT.
          return `
            <div class="event-row ${index % 2 === 0 ? "even" : "odd"}">
              ${index % 2 === 0 ? textBlock + imageBlock : imageBlock + textBlock}
            </div>
          `;
        }).join("");

        if (isAdmin) enableAdminEditing();
        syncHeights();
      })
      .catch(err => {
        console.error("‚ùå Error loading events:", err);
        document.getElementById("events-grid").innerHTML = "<p>Unable to load events.</p>";
      });

    /* ---------------------------------------------------
       üß© Enable Admin Inline Editing (Title, Date, Image)
    --------------------------------------------------- */
    function enableAdminEditing() {
      // ‚úèÔ∏è Title / Date edits
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const index = btn.dataset.index;
          const type = btn.dataset.type;
          const fieldId = `event-${type}-${index}`;
          const fieldEl = document.getElementById(fieldId);
          const currentValue = fieldEl.innerText.trim();
          const newValue = prompt(`Edit event ${type}:`, currentValue);
          if (!newValue || newValue === currentValue) return;

          fieldEl.innerText = newValue;

          const res = await fetch("/admin/update-event", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, [type]: newValue })
          });
          const result = await res.json();
          if (result.success) {
            alert("‚úÖ Event updated successfully!");
            syncHeights();
          } else {
            alert("‚ùå Failed to update event.");
          }
        });
      });

      // üìù Notes editing
      document.querySelectorAll(".event-admin-section").forEach((section, i) => {
        const textDiv = section.querySelector(".admin-display-text");
        const saveBtn = section.querySelector(".save-notes-btn");

        textDiv.contentEditable = "true";
        textDiv.style.border = "1px dashed #282f7f";
        textDiv.style.background = "#fff";
        saveBtn.style.display = "inline-block";

        saveBtn.addEventListener("click", () => {
          const content = textDiv.innerText.trim();
          localStorage.setItem(`eventNotes_${i}`, content);
          alert("‚úÖ Notes saved!");
          syncHeights();
        });
      });

      // üñºÔ∏è Image editing overlay (drag & drop + click upload)
      document.querySelectorAll(".image-edit-overlay").forEach((overlay) => {
        const index = overlay.dataset.index;
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.style.display = "none";
        overlay.appendChild(fileInput);

        ["dragenter", "dragover", "dragleave", "drop"].forEach(evt =>
          overlay.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); })
        );

        overlay.addEventListener("click", () => fileInput.click());
        overlay.addEventListener("dragover", () => {
          overlay.style.background = "rgba(66,121,188,0.95)";
        });
        overlay.addEventListener("dragleave", () => {
          overlay.style.background = "rgba(66,121,188,0.85)";
        });
        overlay.addEventListener("drop", async (e) => {
          overlay.style.background = "rgba(66,121,188,0.85)";
          const file = e.dataTransfer.files[0];
          if (file) await uploadImage(index, file);
        });
        fileInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (file) await uploadImage(index, file);
        });
      });
    }

    /* ---------------------------------------------------
       üì§ Upload Image
    --------------------------------------------------- */
    async function uploadImage(index, file) {
      const formData = new FormData();
      formData.append("image", file);
      formData.append("index", index);
      try {
        const res = await fetch("/admin/upload-image", { method: "POST", body: formData });
        const result = await res.json();
        if (result.success) {
          const img = document.querySelectorAll(".event-img")[index];
          if (img) img.src = "/" + result.image + "?t=" + Date.now();
          alert("‚úÖ Image updated successfully!");
          syncHeights();
        } else {
          alert("‚ùå Upload failed: " + (result.error || "Unknown error"));
        }
      } catch (err) {
        console.error("‚ùå Upload error:", err);
        alert("‚ùå Failed to upload image.");
      }
    }

    /* ---------------------------------------------------
       üß© Sync Image Height with Text Block
    --------------------------------------------------- */
    function syncHeights() {
      const rows = document.querySelectorAll(".event-row");
      rows.forEach(row => {
        const grey = row.querySelector(".grid-item.grey");
        const img = row.querySelector(".grid-item.white img");
        if (grey && img) {
          img.style.height = grey.offsetHeight + "px";
        }
      });
    }

    window.addEventListener("load", syncHeights);
    window.addEventListener("resize", syncHeights);
    window.addEventListener("input", syncHeights);
  </script>
</body>
</html>
